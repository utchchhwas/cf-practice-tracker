
DROP TABLE PROBLEM_DISCUSSIONS;

CREATE TABLE PROBLEM_DISCUSSIONS (
	ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
	AUTHOR VARCHAR2(255),
	CONTEST_ID NUMBER,
	PROBLEM_INDEX VARCHAR2(10),
	LAST_UPDATE_TIME DATE DEFAULT SYSDATE,
	CONTENT CLOB
);

ALTER TABLE PROBLEM_DISCUSSIONS
ADD	CONSTRAINT PROBLEM_DISCUSSIONS_PK 
	PRIMARY KEY (ID);
	

ALTER TABLE PROBLEM_DISCUSSIONS
ADD CONSTRAINT PROBLEM_DISCUSSIONS_FK_1
	FOREIGN KEY (AUTHOR)
	REFERENCES USERS (USERNAME);

ALTER TABLE PROBLEM_DISCUSSIONS
ADD CONSTRAINT PROBLEM_DISCUSSIONS_FK_2
	FOREIGN KEY (CONTEST_ID, PROBLEM_INDEX)
	REFERENCES PROBLEMS (CONTEST_ID, PROBLEM_INDEX);


SELECT * FROM PROBLEM_DISCUSSIONS
;

INSERT INTO
PROBLEM_DISCUSSIONS (AUTHOR, CONTEST_ID, PROBLEM_INDEX, CONTENT)
VALUES ('utchchhwas', 4, 'A', '## This is my discussion')
;

SELECT *
FROM PROBLEM_DISCUSSIONS
WHERE AUTHOR = 'utchchhwas'
		AND PROBLEM_INDEX = 'A'
		
UPDATE PROBLEM_DISCUSSIONS
SET
	CONTENT = 'New content',
	LAST_UPDATE_TIME = SYSDATE
WHERE
	ID = 7


UPDATE PROBLEM_DISCUSSIONS
SET
		UP_VOTES = UP_VOTES + 1
WHERE
		ID = 1
		
		


SELECT 
	D.ID,
	(
		SELECT COUNT(*)
		FROM PROBLEM_DISCUSSIONS_UP_VOTES
		WHERE ID = D.ID
	) UP_VOTES
FROM PROBLEM_DISCUSSIONS D
WHERE
		D.CONTEST_ID = 4
		AND D.PROBLEM_INDEX = 'A'
ORDER BY
		UP_VOTES DESC,
		D.ID DESC






